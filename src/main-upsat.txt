#include <Wire.h>
#include <Adafruit_LSM9DS1.h>
#include <Adafruit_Sensor.h>  // not used in this demo but required!

#include "upsat/WahbaRotM.hpp"

#define loopFreq 100

Adafruit_LSM9DS1 lsm = Adafruit_LSM9DS1();
sensorDat sensorData;
WahbaRotMStruct WStruct;



void setupSensor() {
  lsm.setupAccel(lsm.LSM9DS1_ACCELRANGE_2G);
  lsm.setupMag(lsm.LSM9DS1_MAGGAIN_4GAUSS);
  lsm.setupGyro(lsm.LSM9DS1_GYROSCALE_245DPS);
}



void setup() {
  Serial.begin(9600);
  while(!Serial) {delay(1);} // will pause Zero, Leonardo, etc until serial console opens
  Serial.println("LSM9DS1 upsat library");
  
  // Try to initialise and warn if we couldn't detect the chip
  if(!lsm.begin()) {
    Serial.println("Oops ... unable to initialize the LSM9DS1. Check your wiring!");
    while (1);
  }
  Serial.println("Found LSM9DS1 9DOF");

  // helper to just set the default scaling we want, see above!
  setupSensor();

  initWahbaStruct(&WStruct, 1.0/loopFreq);
  calibSens(sensorData); 
}



void loop() {
  sensors_event_t accelerometers, magnetometers, gyroscopes, temperature;
  lsm.getEvent(&accelerometers, &magnetometers, &gyroscopes, &temperature);

  float accelsRawXYZ[3] = {accelerometers.acceleration.x, accelerometers.acceleration.y, accelerometers.acceleration.z};
  float gyrosRawXYX[3] = {gyroscopes.gyro.x, gyroscopes.gyro.y, gyroscopes.gyro.z};
  float magsRawXYZ[3] = {magnetometers.magnetic.x, magnetometers.magnetic.y, magnetometers.magnetic.z};

  sensorDat sensorData = scaleSens(accelsRawXYZ, gyrosRawXYX, magsRawXYZ);
  WahbaRotM(sensorData.Acc, sensorData.Gyr, sensorData.Mag, &WStruct);
  
  float conversionRadiansToDegrees = 180.0/M_PI;
  String msg = String(WStruct.Euler[0]*conversionRadiansToDegrees) + ' ' + String(WStruct.Euler[1]*conversionRadiansToDegrees) + ' ' + String(WStruct.Euler[2]*conversionRadiansToDegrees) + "\n";
  //String msg = String(sensorData.Gyr[0]) + " " + String(sensorData.Gyr[1]) + " " + String(sensorData.Gyr[2]) + "\n";
  Serial.print(msg);  

  delay(250);
} 