// upsat

#include "../lib/hardware/INS/INS.hpp"
#include "../lib/utils/noiseFilters.hpp"
#include "../lib/algorithms/upsat/WahbaRotM.hpp"



// constants
float loopFreq = 100;
float loopPeriod = 1 / loopFreq;

const int bufferSize = 20;

// LSM9DS1 object, noise filters and upsat algorithm structs
NoiseFilters noiseFiltersAccX, noiseFiltersAccY, noiseFiltersAccZ, noiseFiltersGyroX, noiseFiltersGyroY, noiseFiltersGyroZ, noiseFiltersMagX, noiseFiltersMagY, noiseFiltersMagZ;
sensorDat Vector3d;
WahbaRotMStruct WStructRaw, WStructAverage;



void setup() {
  // set up sensors and upsat algorithm main struct
  setupHardware();
  initWahbaStruct(&WStructRaw, loopPeriod);
  initWahbaStruct(&WStructAverage, loopPeriod);
}

void loop() {
  // get data from sensors
  IMUdata imuRawValues = readSensors();
  String rawDataStr = formatIMUvalues(imuRawValues);


  // average sensor data
  IMUdata imuAverageValues = imuRawValues;
  
  //imuAverageValues.getAccelerometers().x = noiseFiltersAccX.updateMovingAverage(imuRawValues.getAccelerometers().x);
  //imuAverageValues.getAccelerometers().y = noiseFiltersAccY.updateMovingAverage(imuRawValues.getAccelerometers().y);
  //imuAverageValues.getAccelerometers().z = noiseFiltersAccZ.updateMovingAverage(imuRawValues.getAccelerometers().z);

  //imuAverageValues.getMagnetometers().x = noiseFiltersGyroX.updateMovingAverage(imuRawValues.getGyroscopes().x);
  //imuAverageValues.getMagnetometers().y = noiseFiltersGyroY.updateMovingAverage(imuRawValues.getGyroscopes().y);
  //imuAverageValues.getMagnetometers().z = noiseFiltersGyroZ.updateMovingAverage(imuRawValues.getGyroscopes().z);

  //imuAverageValues.getMagnetometers().x = noiseFiltersMagX.updateMovingAverage(imuRawValues.getMagnetometers().x);
  //imuAverageValues.getMagnetometers().y = noiseFiltersMagY.updateMovingAverage(imuRawValues.getMagnetometers().y);
  //imuAverageValues.getMagnetometers().z = noiseFiltersMagZ.updateMovingAverage(imuRawValues.getMagnetometers().z);

  // calculate attitude using upsat algorithm
  
  // raw pitch, roll and yaw
  float accsRaw[3] = {imuRawValues.getAccelerometers().x, imuRawValues.getAccelerometers().y, imuRawValues.getAccelerometers().z};
  float gyrosRaw[3] = {imuRawValues.getGyroscopes().x, imuRawValues.getGyroscopes().y, imuRawValues.getGyroscopes().z};
  float magsRaw[3] = {imuRawValues.getMagnetometers().x, imuRawValues.getMagnetometers().y, imuRawValues.getMagnetometers().z};

  sensorDat sensorRawData = scaleSens(accsRaw, gyrosRaw, magsRaw);
  WahbaRotM(sensorRawData.Acc, sensorRawData.Gyr, sensorRawData.Mag, &WStructRaw);

  Attitude currentAttitudeRawRadians = fillAttitudeValues(WStructRaw.Euler[0], WStructRaw.Euler[1], WStructRaw.Euler[2]);
  Attitude currentAttitudeRawDegrees = convertAttitudeRadiansToDegrees(currentAttitudeRawRadians);
  String attitudeRawDegreesStr = formatAttitudeValues(currentAttitudeRawDegrees);
  String pitchAndRollRawDegreesStr = formatPitchandRoll(currentAttitudeRawDegrees);
  
  // average pith, roll and yaw
  //float accAvererage[3] = {imuAverageValues.getAccelerometers().x, imuAverageValues.getAccelerometers().y, imuAverageValues.getAccelerometers().z};
  //float gyroAverage[3] = {imuAverageValues.getGyroscopes().x, imuAverageValues.getGyroscopes().y, imuAverageValues.getGyroscopes().z};
  //float magsAverage[3] = {imuAverageValues.getMagnetometers().x, imuAverageValues.getMagnetometers().y, imuAverageValues.getMagnetometers().z};
  //
  //sensorDat sensorAverageData = scaleSens(accAvererage, gyroAverage, magsAverage);
  //WahbaRotM(sensorAverageData.Acc, sensorAverageData.Gyr, sensorAverageData.Mag, &WStructAverage);
  
  Serial.println(pitchAndRollRawDegreesStr);
}